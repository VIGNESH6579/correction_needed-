<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Tests - Interview Portal</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1>Interview Portal</h1>
            </div>
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="courses.html">Courses</a></li>
                <li><a href="coding.html">Coding</a></li>
                <li><a href="tests.html">Tests</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Tests Section -->
    <section class="tests-section">
        <div class="container">
            <h2>Mock Tests</h2>
            
            <div id="testsList" class="tests-grid">
                <p>Loading tests...</p>
            </div>
        </div>
    </section>

    <!-- Test Interface Modal -->
    <div id="testModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeTest()">&times;</span>
            <h2 id="testTitle">Test</h2>
            
            <div class="test-interface">
                <div class="test-header">
                    <p><strong>Time Remaining:</strong> <span id="timeRemaining">00:00</span></p>
                    <p><strong>Question:</strong> <span id="questionNumber">1</span> of <span id="totalQuestions">0</span></p>
                </div>

                <div class="test-content">
                    <div id="questionContainer"></div>
                    <div id="optionsContainer"></div>
                </div>

                <div class="test-buttons">
                    <button onclick="previousQuestion()" class="btn btn-secondary" id="prevBtn">Previous</button>
                    <button onclick="nextQuestion()" class="btn btn-secondary" id="nextBtn">Next</button>
                    <button onclick="submitTest()" class="btn btn-success">Submit Test</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResults()">&times;</span>
            <h2>Test Results</h2>
            
            <div id="resultsContent"></div>
            
            <button onclick="closeResults()" class="btn btn-primary">Close</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Interview Portal. All rights reserved.</p>
        </div>
    </footer>

    <script src="../js/app.js"></script>
    <script>
        let allTests = [];
        let currentTest = null;
        let testQuestions = [];
        let currentQuestionIndex = 0;
        let testAnswers = {};
        let testStartTime = null;
        let timeInterval = null;

        window.addEventListener('load', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/api/tests', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                allTests = await response.json();
                displayTests(allTests);
            } catch (error) {
                console.error('Error loading tests:', error);
            }
        });

        function displayTests(tests) {
            const testsList = document.getElementById('testsList');
            testsList.innerHTML = '';

            if (tests.length === 0) {
                testsList.innerHTML = '<p>No tests available</p>';
                return;
            }

            tests.forEach(test => {
                const testCard = document.createElement('div');
                testCard.className = 'test-card';
                testCard.innerHTML = `
                    <h3>${test.title}</h3>
                    <p>${test.description}</p>
                    <p><strong>Duration:</strong> ${test.durationMinutes} minutes</p>
                    <p><strong>Total Questions:</strong> ${test.totalQuestions}</p>
                    <p><strong>Passing Score:</strong> ${test.passingScore}%</p>
                    <button onclick="startTest(${test.id})" class="btn btn-primary">Start Test</button>
                `;
                testsList.appendChild(testCard);
            });
        }

        async function startTest(testId) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`http://localhost:8080/api/tests/${testId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                currentTest = await response.json();

                // Generate mock questions for the test
                testQuestions = generateMockQuestions(currentTest.totalQuestions);
                currentQuestionIndex = 0;
                testAnswers = {};
                testStartTime = Date.now();

                document.getElementById('testTitle').textContent = currentTest.title;
                document.getElementById('totalQuestions').textContent = currentTest.totalQuestions;
                document.getElementById('testModal').style.display = 'block';

                startTimer();
                displayQuestion();
            } catch (error) {
                console.error('Error starting test:', error);
            }
        }

        function generateMockQuestions(count) {
            const questions = [];
            for (let i = 0; i < count; i++) {
                questions.push({
                    id: i + 1,
                    text: `Question ${i + 1}: This is a sample question?`,
                    options: ['Option A', 'Option B', 'Option C', 'Option D'],
                    correctAnswer: Math.floor(Math.random() * 4)
                });
            }
            return questions;
        }

        function startTimer() {
            let timeLeft = currentTest.durationMinutes * 60;
            timeInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timeRemaining').textContent = 
                    String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');

                if (timeLeft <= 0) {
                    clearInterval(timeInterval);
                    submitTest();
                }
            }, 1000);
        }

        function displayQuestion() {
            const question = testQuestions[currentQuestionIndex];
            document.getElementById('questionNumber').textContent = currentQuestionIndex + 1;

            const questionContainer = document.getElementById('questionContainer');
            questionContainer.innerHTML = `<p>${question.text}</p>`;

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const checked = testAnswers[currentQuestionIndex] === index ? 'checked' : '';
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.innerHTML = `
                    <input type="radio" name="answer" value="${index}" ${checked} 
                           onchange="testAnswers[${currentQuestionIndex}] = ${index}">
                    <label>${option}</label>
                `;
                optionsContainer.appendChild(optionDiv);
            });

            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === testQuestions.length - 1;
        }

        function nextQuestion() {
            if (currentQuestionIndex < testQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function submitTest() {
            clearInterval(timeInterval);

            // Calculate results
            let correctAnswers = 0;
            testQuestions.forEach((question, index) => {
                if (testAnswers[index] === question.correctAnswer) {
                    correctAnswers++;
                }
            });

            const wrongAnswers = testQuestions.length - correctAnswers;
            const percentage = (correctAnswers / testQuestions.length) * 100;
            const status = percentage >= currentTest.passingScore ? 'PASSED' : 'FAILED';

            // Display results
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="results-summary">
                    <h3>Test Completed!</h3>
                    <p><strong>Status:</strong> <span class="${status.toLowerCase()}">${status}</span></p>
                    <p><strong>Correct Answers:</strong> ${correctAnswers} / ${testQuestions.length}</p>
                    <p><strong>Wrong Answers:</strong> ${wrongAnswers}</p>
                    <p><strong>Percentage:</strong> ${percentage.toFixed(2)}%</p>
                    <p><strong>Passing Score:</strong> ${currentTest.passingScore}%</p>
                </div>
            `;

            document.getElementById('testModal').style.display = 'none';
            document.getElementById('resultsModal').style.display = 'block';
        }

        function closeTest() {
            clearInterval(timeInterval);
            document.getElementById('testModal').style.display = 'none';
        }

        function closeResults() {
            document.getElementById('resultsModal').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>
