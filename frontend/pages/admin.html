<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Interview Portal</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1>Interview Portal</h1>
            </div>
            <ul class="nav-links">
                <li><a href="admin.html">Admin Panel</a></li>
                <li><a href="#" onclick="switchTab('users')">Users</a></li>
                <li><a href="#" onclick="switchTab('approvals')">Approvals</a></li>
                <li><a href="#" onclick="switchTab('stats')">Statistics</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Admin Panel Section -->
    <section class="admin-section">
        <div class="container">
            <h2>Admin Control Panel</h2>

            <!-- Statistics Tab -->
            <div id="statsTab" class="tab-content">
                <h3>Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Users</h4>
                        <p id="totalUsers" class="stat-number">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Total Students</h4>
                        <p id="totalStudents" class="stat-number">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Pending Approvals</h4>
                        <p id="pendingApprovals" class="stat-number">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Approved Users</h4>
                        <p id="approvedUsers" class="stat-number">0</p>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content" style="display:none;">
                <h3>All Users</h3>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="7">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Approvals Tab -->
            <div id="approvalsTab" class="tab-content" style="display:none;">
                <h3>Pending Approvals</h3>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="approvalsTableBody">
                        <tr><td colspan="5">Loading pending approvals...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Interview Portal. All rights reserved.</p>
        </div>
    </footer>

    <script src="../js/app.js"></script>
    <script>
        window.addEventListener('load', async () => {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));

            if (!token || user.role !== 'ADMIN') {
                window.location.href = 'login.html';
                return;
            }

            loadStatistics(token);
            loadAllUsers(token);
            loadPendingApprovals(token);
        });

        async function loadStatistics(token) {
            try {
                const response = await fetch('http://localhost:8080/api/admin/stats', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const stats = await response.json();

                document.getElementById('totalUsers').textContent = stats.totalUsers;
                document.getElementById('totalStudents').textContent = stats.totalStudents;
                document.getElementById('pendingApprovals').textContent = stats.pendingApprovals;
                document.getElementById('approvedUsers').textContent = stats.approvedUsers;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadAllUsers(token) {
            try {
                const response = await fetch('http://localhost:8080/api/admin/users', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const users = await response.json();
                displayUsersTable(users);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No users found</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.department}</td>
                    <td>${user.role}</td>
                    <td>${user.status}</td>
                    <td>
                        <button onclick="deleteUser(${user.id})" class="btn btn-danger">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadPendingApprovals(token) {
            try {
                const response = await fetch('http://localhost:8080/api/admin/pending-approvals', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const users = await response.json();
                displayApprovalsTable(users);
            } catch (error) {
                console.error('Error loading pending approvals:', error);
            }
        }

        function displayApprovalsTable(users) {
            const tbody = document.getElementById('approvalsTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No pending approvals</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.department}</td>
                    <td>
                        <button onclick="approveUser(${user.id})" class="btn btn-success">Approve</button>
                        <button onclick="rejectUser(${user.id})" class="btn btn-danger">Reject</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function approveUser(userId) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`http://localhost:8080/api/admin/users/${userId}/approve`, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    alert('User approved successfully');
                    location.reload();
                } else {
                    alert('Error approving user');
                }
            } catch (error) {
                console.error('Error approving user:', error);
            }
        }

        async function rejectUser(userId) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`http://localhost:8080/api/admin/users/${userId}/reject`, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    alert('User rejected successfully');
                    location.reload();
                } else {
                    alert('Error rejecting user');
                }
            } catch (error) {
                console.error('Error rejecting user:', error);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`http://localhost:8080/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    alert('User deleted successfully');
                    location.reload();
                } else {
                    alert('Error deleting user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
            }
        }

        function switchTab(tabName) {
            document.getElementById('statsTab').style.display = 'none';
            document.getElementById('usersTab').style.display = 'none';
            document.getElementById('approvalsTab').style.display = 'none';

            if (tabName === 'stats') {
                document.getElementById('statsTab').style.display = 'block';
            } else if (tabName === 'users') {
                document.getElementById('usersTab').style.display = 'block';
            } else if (tabName === 'approvals') {
                document.getElementById('approvalsTab').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>
